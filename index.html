<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ğŸ‘€ã¿ã¦ã¤ãã‚‹ã‚·ãƒ¼ãƒˆğŸš—</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: sans-serif; background: #f0f2f5; color: #333; max-width: 960px; margin: 0 auto; min-height: 100vh; }

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
.header { background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; text-align: center; padding: 1.5rem 1rem; }
.header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
.header p { font-size: 1.2rem; opacity: 0.9; }

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.nav-container { width: 100%; overflow-x: auto; background: white; padding: 12px 10px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.1); -webkit-overflow-scrolling: touch; }
.nav-scroll { display: inline-flex; gap: 10px; min-width: max-content; }
.nav-btn { flex-shrink: 0; padding: 16px 18px; font-size: 1.3rem; font-weight: bold; border: none; border-radius: 16px; background: #e1f5fe; color: #0288d1; min-width: 130px; min-height: 65px; cursor: pointer; }
.nav-btn.active { background: #ff9800; color: white; }

/* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
.main-content { padding: 20px 15px; }
.step-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
.step-title { font-size: 1.8rem; color: #1565C0; margin-bottom: 20px; font-weight: bold; }
.danger-border { border: 4px solid #ff5252; }
.final-bg { background: #fffde7 !important; }

/* å†™çœŸè¡¨ç¤ºï¼ˆç¸¦è¡¨ç¤ºç”¨ã«èª¿æ•´ï¼‰ */
.photo-list { display: flex; flex-direction: column; gap: 25px; margin-bottom: 20px; }
.photo-container { position: relative; background: #000; border-radius: 15px; overflow: hidden; line-height: 0; aspect-ratio: 3/4; max-height: 450px; }
.step-image { width: 100%; height: 100%; object-fit: contain; cursor: pointer; touch-action: manipulation; }
.tap-label { position: absolute; bottom: 12px; right: 12px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.9rem; pointer-events: none; }
.photo-caption { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); color: white; padding: 6px 10px; border-radius: 10px; font-size: 0.9rem; pointer-events: none; }

/* ã‚¢ãƒ«ãƒãƒ  */
.album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 25px; }
.album-item { position: relative; border-radius: 15px; overflow: hidden; background: white; box-shadow: 0 3px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.album-img-wrapper { position: relative; aspect-ratio: 1; overflow: hidden; background: #eee; }
.album-item img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; touch-action: manipulation; }
.album-info { padding: 12px; }
.album-name { font-weight: bold; font-size: 1.3rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
.album-date { font-size: 1rem; color: #777; }

.add-photo-btn { background: #4caf50; color: white; border: none; padding: 20px; border-radius: 15px; width: 100%; font-size: 1.5rem; font-weight: bold; cursor: pointer; margin-bottom: 15px; min-height: 70px; }
.del-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 24px; z-index: 10; cursor: pointer; }

/* æ‹¡å¤§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 10000; display: none; touch-action: none; overflow: hidden; }
.overlay.active { display: block; }
.overlay-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
.overlay-image { max-width: 100%; max-height: 100%; object-fit: contain; transform-origin: center center; touch-action: none; pointer-events: none; }
.close-btn { position: fixed; top: 20px; right: 20px; width: 80px; height: 80px; border-radius: 50%; background: white; border: none; font-weight: bold; font-size: 1.8rem; z-index: 10001; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

/* ã‚¹ãƒ†ãƒƒãƒ—å†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.ok-box { background: #e8f5e9; padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 1.4rem; }
.note-box { background: #fff3e0; padding: 15px; border-radius: 12px; font-size: 1.4rem; }
</style>
</head>
<body>

<header class="header">
  <h1>ğŸ‘€ã¿ã¦ã¤ãã‚‹ã‚·ãƒ¼ãƒˆğŸš—</h1>
  <p>ã¿ã‚“ãªã®å·¥ä½œã‚’ã‚¢ãƒ«ãƒãƒ ã«ã®ã“ãã†ï¼</p>
</header>

<div class="nav-container">
  <div class="nav-scroll" id="navButtons"></div>
</div>

<main class="main-content" id="content"></main>

<script>
const steps = [
  { nav: "â‘  ã§ã‚“ã¡", title: "â‘  ã§ã‚“ã¡ï¼ˆBOXï¼‰", img1: "images/battery_box.jpg", img2: "images/battery_box2.jpg", ok: "é›»æ± ã®å‘ãOKï¼", note: "ï¼‹ã¨ï¼ã‚’ç¢ºèªã—ã¾ã™ã€‚" },
  { nav: "â‘¡ ã›ã‚“", title: "â‘¡ é›»æ± ã«ã¤ã‘ã‚‹é›»ç·š", img1: "images/wire_magnet.jpg", img2: "images/wire_magnet2.jpg", ok: "ç·šãŒã¤ãªãŒã£ãŸï¼", note: "ç£çŸ³ãŒã—ã£ã‹ã‚Šä»˜ã„ã¦ã„ã‚‹ã‹ç¢ºèªã€‚" },
  { nav: "â‘¢ ã‚¹ã‚¤ãƒƒãƒ", title: "â‘¢ å‰å¾Œåˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ", img1: "images/switch_complete.jpg", img2: "images/switch_complete2.jpg", ok: "å‰å¾ŒãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ï¼", note: "å·¦å³SWã‚’æŠ¼ã—ã¦åˆ‡ã‚Šæ›¿ã‚ã‚‹ã‹ç¢ºèªã€‚" },
  { nav: "â‘£ ã¾ã‚ã‚‹", title: "â‘£ ãƒ¢ãƒ¼ã‚¿ãƒ¼ã¯å›ã‚‹ï¼Ÿ", img1: "images/motor_test.jpg", img2: "images/motor_test2.jpg", ok: "å›ã‚Œã° OK", note: "æŒ‡ã‚’è¿‘ã¥ã‘ãªã„ã‚ˆã†æ³¨æ„ã€‚" },
  { nav: "â‘¤ ã¿ãŸã‚", title: "â‘¤ è¦‹ãŸç›®å®Œæˆï¼ˆå®Ÿé¨“ä¸­ï¼‰", img1: "images/car_complete.jpg", img2: "images/car_complete2.jpg", ok: "ã¤ãªãæ–¹ã‚’ãŸã‚ãã†ï¼", note: "å‰å¾ŒãŒé€†ãªã‚‰å…¥ã‚Œæ›¿ãˆã¦ã¿ã‚ˆã†ã€‚", danger: true },
  { nav: "â‘¥ ã‹ã‚“ã›ã„", title: "â‘¥ ã»ã‚“ã¨ã†ã®å®Œæˆï¼", img1: "images/complete.jpg", img2: "images/complete2.jpg", ok: "å‰å¾Œã«å‹•ã„ãŸã‚‰å¤§æˆåŠŸï¼", note: "å®‰å…¨ã«èµ°ã‚‰ã›ã‚ˆã†ã€‚", final: true },
  { nav: "ğŸ“¸ã‚¢ãƒ«ãƒãƒ ", title: "ğŸ“¸ ãŠã‚‚ã„ã§ã‚¢ãƒ«ãƒãƒ ", isAlbum: true }
];

let currentStep = 0;
const navButtons = document.getElementById('navButtons');
const content = document.getElementById('content');

// æ‹¡å¤§æ©Ÿèƒ½ã®çŠ¶æ…‹ç®¡ç†
let scale = 1;
let translateX = 0;
let translateY = 0;
let lastX = 0;
let lastY = 0;
let isDragging = false;
let pointers = {};
let overlay = null;
let overlayImg = null;

function render() {
  navButtons.innerHTML = '';
  steps.forEach((s, i) => {
    const b = document.createElement('button');
    b.className = `nav-btn ${i === currentStep ? 'active' : ''}`;
    b.textContent = s.nav;
    b.onclick = () => { currentStep = i; render(); };
    navButtons.appendChild(b);
  });

  const s = steps[currentStep];
  if (s.isAlbum) {
    renderAlbumView(s);
  } else {
    renderStepView(s);
  }
}

function renderStepView(s) {
  let photoHtml = `
    <div class="photo-container" onclick="openOverlay('${s.img1}')">
      <img src="${s.img1}" class="step-image">
      <div class="photo-caption">æ­£é¢ã‹ã‚‰</div>
      <div class="tap-label">ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§</div>
    </div>
    <div class="photo-container" onclick="openOverlay('${s.img2}')">
      <img src="${s.img2}" class="step-image">
      <div class="photo-caption">å´é¢ã‹ã‚‰</div>
      <div class="tap-label">ã‚¿ãƒƒãƒ—ã§æ‹¡å¤§</div>
    </div>
  `;

  let cardClass = 'step-card';
  if (s.danger) cardClass += ' danger-border';
  if (s.final) cardClass += ' final-bg';

  content.innerHTML = `
    <div class="${cardClass}">
      <div class="step-title">${s.title}</div>
      <div class="photo-list">${photoHtml}</div>
      <div class="ok-box"><b>${s.ok}</b></div>
      <div class="note-box">${s.note}</div>
    </div>`;
}

function renderAlbumView(s) {
  let savedPhotos = JSON.parse(localStorage.getItem('myAlbumV3') || '[]');
  savedPhotos.sort((a, b) => b.timestamp - a.timestamp);

  let albumHtml = savedPhotos.map((item, index) => {
    const dateStr = new Date(item.timestamp).toLocaleString('ja-JP', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    return `
    <div class="album-item">
      <button class="del-btn" onclick="deletePhoto(${item.timestamp})">Ã—</button>
      <div class="album-img-wrapper">
        <img src="${item.dataUrl}" onclick="openOverlay('${item.dataUrl}')">
      </div>
      <div class="album-info">
        <span class="album-name">${item.name || 'ãªã¾ãˆãªã—'}</span>
        <span class="album-date">${dateStr}</span>
      </div>
    </div>
  `}).join('');

  content.innerHTML = `
    <div class="step-card">
      <div class="step-title">${s.title}</div>
      <p style="margin-bottom:20px; font-size:1.4rem;">å·¥ä½œã«ã€Œãªã¾ãˆã€ã‚’ã¤ã‘ã¦ã®ã“ãã†ï¼</p>
      <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="savePhoto(event)">
      <button class="add-photo-btn" onclick="document.getElementById('cameraInput').click()">ğŸ“· å†™çœŸã‚’ã¨ã‚‹ãƒ»ãˆã‚‰ã¶</button>
      <div class="album-grid">${albumHtml}</div>
    </div>`;
}

function savePhoto(event) {
  const file = event.target.files[0];
  if (!file) return;

  const workName = prompt("å·¥ä½œã®ã€Œãªã¾ãˆã€ã‚’æ•™ãˆã¦ã­ï¼", "ã˜ã¶ã‚“ã®å·¥ä½œ");
  if (workName === null) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const savedPhotos = JSON.parse(localStorage.getItem('myAlbumV3') || '[]');
    const newItem = {
      dataUrl: e.target.result,
      name: workName,
      timestamp: Date.now()
    };
    savedPhotos.push(newItem);
    localStorage.setItem('myAlbumV3', JSON.stringify(savedPhotos));
    render();
  };
  reader.readAsDataURL(file);
}

function deletePhoto(timestamp) {
  if (!confirm('ã“ã®å†™çœŸã‚’ã‘ã—ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ')) return;
  let savedPhotos = JSON.parse(localStorage.getItem('myAlbumV3') || '[]');
  savedPhotos = savedPhotos.filter(item => item.timestamp !== timestamp);
  localStorage.setItem('myAlbumV3', JSON.stringify(savedPhotos));
  render();
}

// ================= æ‹¡å¤§æ©Ÿèƒ½ï¼ˆå³æ ¼å®Ÿè£…ï¼‰ =================
function openOverlay(src) {
  if (overlay) return;

  overlay = document.createElement('div');
  overlay.className = 'overlay';
  overlay.innerHTML = `
    <div class="overlay-content">
      <img src="${src}" class="overlay-image">
    </div>
    <button class="close-btn" onclick="closeOverlay()">Ã—<br>ã¨ã˜ã‚‹</button>
  `;

  document.body.appendChild(overlay);
  overlayImg = overlay.querySelector('.overlay-image');

  setTimeout(() => overlay.classList.add('active'), 10);
  document.body.style.overflow = 'hidden';

  initOverlayEvents();
  resetTransform();
}

function closeOverlay() {
  if (!overlay) return;
  overlay.classList.remove('active');
  setTimeout(() => {
    if (overlay && overlay.parentNode) {
      overlay.parentNode.removeChild(overlay);
    }
    overlay = null;
    overlayImg = null;
    document.body.style.overflow = '';
    pointers = {};
  }, 300);
}

function initOverlayEvents() {
  if (!overlay || !overlayImg) return;

  overlay.addEventListener('pointerdown', handlePointerDown);
  overlay.addEventListener('pointermove', handlePointerMove);
  overlay.addEventListener('pointerup', handlePointerUp);
  overlay.addEventListener('pointercancel', handlePointerUp);
  overlay.addEventListener('wheel', handleWheel, { passive: false });

  overlayImg.addEventListener('pointerdown', (e) => e.stopPropagation());
  overlayImg.addEventListener('pointermove', (e) => e.stopPropagation());
  overlayImg.addEventListener('pointerup', (e) => e.stopPropagation());
  overlayImg.addEventListener('pointercancel', (e) => e.stopPropagation());
}

function resetTransform() {
  scale = 1;
  translateX = 0;
  translateY = 0;
  updateTransform();
}

function updateTransform() {
  if (!overlayImg) return;
  const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
  const isPortrait = window.innerHeight > window.innerWidth;

  let transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
  if (isMobile && isPortrait) {
    transform += ' rotate(90deg)';
  }
  overlayImg.style.transform = transform;
}

function handlePointerDown(e) {
  e.stopPropagation();
  pointers[e.pointerId] = { x: e.clientX, y: e.clientY };
}

function handlePointerMove(e) {
  e.stopPropagation();
  if (!pointers[e.pointerId]) return;

  const currentX = e.clientX;
  const currentY = e.clientY;
  const prev = pointers[e.pointerId];

  const activePointers = Object.keys(pointers).length;

  if (activePointers === 1) {
    if (scale <= 1.01) return;

    translateX += currentX - prev.x;
    translateY += currentY - prev.y;

    pointers[e.pointerId] = { x: currentX, y: currentY };
    updateTransform();
  } else if (activePointers === 2) {
    const ids = Object.keys(pointers);
    if (ids.length !== 2) return;

    const p1 = pointers[ids[0]];
    const p2 = pointers[ids[1]];

    const currentDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
    const newDist = Math.hypot(currentX - (ids[0] == e.pointerId ? p2.x : p1.x),
                               currentY - (ids[0] == e.pointerId ? p2.y : p1.y));

    const delta = newDist - currentDist;
    const newScale = Math.min(Math.max(scale + delta * 0.01, 1), 5);

    scale = newScale;

    pointers[e.pointerId] = { x: currentX, y: currentY };
    updateTransform();
  }
}

function handlePointerUp(e) {
  e.stopPropagation();
  delete pointers[e.pointerId];
}

function handleWheel(e) {
  e.preventDefault();
  e.stopPropagation();

  const delta = e.deltaY > 0 ? -0.2 : 0.2;
  scale = Math.min(Math.max(scale + delta, 1), 5);
  updateTransform();
}

window.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
